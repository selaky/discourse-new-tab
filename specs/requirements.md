# 项目简介

## 名称

*   Discourse 新标签页
*   discourse-new-tab

## 描述

在 Discourse 论坛内，对部分链接改为在新标签页打开，而不是默认在原标签页打开，从而优化浏览体验。

## 目标群体

喜欢用新标签页刷论坛，但是不想每次都用鼠标中键或 `Ctrl` + 点击来打开链接的用户。

## 平台

Tampermonkey

## 适用范围

仅在 Discourse 类型的论坛生效。
暂不支持GitHub Community类和极少数深度定制类论坛.
在其他页面，脚本将停止核心功能，仅保留设置菜单入口和功能，以减少性能干扰。

# 功能需求

## 1. 论坛识别

**1.1 自动识别**
结合多种判断方式，尽量精准地识别 Discourse 类型的论坛。

**1.2 强制白名单**
用户可手动添加白名单，以应对自动识别失效的状况。

**1.3 黑名单**
用户可添加黑名单，使脚本不在指定的域名生效。

## 2. 跳转规则

每个细分规则均可在配置界面中独立启用或禁用。以下所有描述均为对应规则开启时的行为。对于所有设定为“保留原生跳转方式”的规则，如果用户在设置中将其关闭，则行为会变为“在新标签页打开”。

若一个链接同时满足多条规则，将以顺序靠后的规则为准。

**2.1 主题帖**
*   从任意页面打开主题帖时，用新标签页打开。
*   在主题帖内部点击其他链接时，用新标签页打开。
*   如果目标链接与当前页面为同一主题帖（即链接内主题编号相同，通常为楼层跳转），则保留原生跳转方式（在当前页面跳转）。

**2.2 个人主页**
*   从任意页面打开用户个人主页时，用新标签页打开。
*   在用户个人主页内点击其他链接时，用新标签页打开。
*   如果目标链接与当前页面为同一用户的主页（即链接内用户名相同），则保留原生跳转方式。

**2.3 附件**
*   打开图片等附件时，保留原生跳转方式。

**2.4 弹窗**

此部分将分别描述脚本启用前（原生行为）和启用后（脚本行为）的逻辑。

**2.4.1 用户卡片**
*   **原生行为：** 点击任意用户头像，会出现该用户的卡片弹窗。点击卡片中的任意链接，页面会在原标签页跳转。
*   **脚本行为：**
    *   点击任意用户头像，正常显示用户卡片弹窗（不做改变）。
    *   点击卡片中的任意链接，在新标签页打开。

**2.4.2 用户菜单**
*   **原生行为：** 点击右上角自己的头像，出现用户菜单弹窗。此弹窗包含左侧的内容面板和右侧的分类选项卡。
    *   点击内容面板里的任意链接，页面会在原标签页跳转。
    *   点击分类选项卡中的某个图标，内容面板会切换至对应内容（仅弹窗内变化，页面不跳转）。
    *   再次点击已选中的分类图标，页面会在原标签页打开该分类的链接。
*   **脚本行为：**
    *   点击右上角自己的头像，正常显示用户菜单弹窗（不做改变）。
    *   点击内容面板里的任意链接，在新标签页打开。
    *   点击分类选项卡中的某个图标，内容面板正常切换（不做改变）。
    *   再次点击已选中的分类图标，在新标签页打开该分类的链接。

## 3. 设置界面

设置界面可通过脚本管理器的菜单进入。界面需简洁清晰，并支持浅色、深色、自动三种夜间模式。

设置界面内容结构如下：

---
**当前域名：** `example.com`
**状态：** 已启用 / 未启用 (原因 - 括号内用一个词说明启用或未启用原因,如白名单)

---
### **论坛识别**

**白名单 - 强制启用脚本**
域名    [编辑] [删除]
域名    [编辑] [删除]
......
[输入框]  [添加]
[一键添加当前域名]

**黑名单 - 强制禁用脚本**
域名    [编辑] [删除]
域名    [编辑] [删除]
......
[输入框]  [添加]
[一键添加当前域名]

---
### **跳转规则**

（此处按分类清晰地罗列所有可配置的跳转规则，每条规则前带有一个勾选框用于启用/禁用。）

# 代码设计

*   **极致性能**：用户在安装该脚本前后，浏览任意网页不应有可感知的速度变化（如页面打开变慢）。
*   **规则可拓展性**：规则相关的代码应易于添加、修改和删除。通过良好的代码设计，提前降低后续维护时(如增加或减少规则)出现 Bug 的可能性。
*   **统一跳转处理**：判断规则的逻辑不应直接操作页面。应由一个专门的模块收集各规则的判断结果，最终决策采用何种跳转方式，并交由对应的函数处理。
*   **链接跳转的三种操作类型**：
    *   **新标签页打开**：强制在新标签页打开链接。
    *   **维持原生方式**：保持与网站自身行为完全一致，无论是原标签页、新标签页、弹窗或其他任何方式。
    *   **原标签页打开**：强制在原标签页打开链接。此操作应尽量避免，优先采用“维持原生方式”。当前没有必须依赖此方式的规则，仅作为未来备用。
*   **模块化开发**：每个模块只负责完成自身的一小块功能，保持高内聚、低耦合。
*   **构建与发布**：采用可靠的工具打包生成最终的 `.js` 脚本。源码与构建产物分离，用户安装的应是构建产物,AI不可直接编辑构建产物。
*   **分步开发**：每次只完成一个部分的开发，在经过用户实际验证和确认后，再进行下一步开发。

# 附录

**Discourse 论坛链接示例：**
*   `https://linux.do/`
*   `https://linux.do/t/topic/1006706`
*   `https://linux.do/t/topic/991874/6`
*   `https://linux.do/c/wiki/42`
*   `https://linux.do/u/neo/summary`
*   `https://meta.appinn.net/t/topic/2319`
*   `https://meta.appinn.net/u/qingwa/summary`
*   `https://blenderartists.org/t/faq-work-in-progress/1276424`